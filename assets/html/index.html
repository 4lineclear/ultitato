<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Ultitato</title>
    <!-- Potato favicon -->
    <link
      rel="icon"
      type="image/x-icon"
      href="https://img.icons8.com/office/40/potato.png"
    />
    <!--Import bootstrap-->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
      crossorigin="anonymous"
    />
    <!-- bootstrap icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css"
    />
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>

  <body>
    <!-- top of body to prevent color blinking -->
    <script>
      // Set theme to the user's preferred color scheme
      function updateTheme() {
        const colorMode = window.matchMedia("(prefers-color-scheme: dark)")
          .matches
          ? "dark"
          : "light";
        document.querySelector("html").setAttribute("data-bs-theme", colorMode);
      }
      // Set theme on load
      updateTheme();
      // Update theme when the preferred scheme changes
      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", updateTheme);
    </script>
    <p class="fst-italic fixed-top text-end me-3">
      <a href="https://icons8.com/icon/31728/potato">Favicon</a> by
      <a href="https://icons8.com">Icons8</a>
    </p>
    <div class="container text-center">
      <h1 class="display-1 text-primary">Ultitato</h1>
      <p class="lead fst-italic">
        <span class="text-primary">Ul</span>timate
        <span class="text-primary">Ti</span>c-<span class="text-primary"
          >Ta</span
        >c-<span class="text-primary">To</span>e
      </p>
      <div
        class="btn-group btn-group-lg d-flex"
        role="group"
        aria-label="Game choices"
      >
        <button
          onclick="window.location += 'local'"
          role="button"
          class="btn btn-primary w-100"
          style="height: 70vh"
        >
          <div>
            <hr />
            <h2 class="display-2">Local</h2>
            <hr />
            <i class="bi bi-laptop" style="font-size: 10vmin"></i>
          </div>
        </button>
        <button
          onclick="registerJoin()"
          role="button"
          class="btn btn-primary w-100"
          style="height: 70vh"
          data-bs-toggle="modal"
          data-bs-target="#join-modal"
        >
          <div>
            <hr />
            <h2 class="display-2">Join</h2>
            <hr />
            <i class="bi bi-wifi" style="font-size: 10vmin"></i>
          </div>
        </button>
        <button
          onclick="registerHost()"
          role="button"
          class="btn btn-primary w-100"
          style="height: 70vh"
          data-bs-toggle="modal"
          data-bs-target="#host-modal"
        >
          <div>
            <hr />
            <h2 class="display-2">Host</h2>
            <hr />
            <i class="bi bi-wifi" style="font-size: 10vmin"></i>
          </div>
        </button>
      </div>
    </div>
    <!-- Join Modal -->
    <div
      class="modal fade"
      id="join-modal"
      tabindex="-1"
      role="dialog"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Join game</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="modal-body form-floating mb-3">
              <input
                type="text"
                class="form-control"
                name="game-id-query"
                id="game-id-query"
              />
              <label for="game-id-query">Game ID</label>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button id="join-button" class="btn btn-primary">Play</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Host Modal -->
    <div
      class="modal fade"
      id="host-modal"
      tabindex="-1"
      role="dialog"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Host game</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div id="host-form">
            <div class="modal-body form-floating mb-3">
              <input
                type="text"
                class="form-control"
                name="game-id"
                id="game-id"
                value="id-not-made"
                readonly
              />
              <label id="game-id-label" for="game-id">Game ID</label>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Close
              </button>
              <button
                id="host-submit"
                type="submit"
                class="btn btn-primary"
                disabled
              >
                <span
                  class="spinner-border spinner-border-sm"
                  aria-hidden="true"
                ></span>
                <span role="status">Waiting for player</span>
              </button>
            </div>
          </div>
          <div id="server-full" class="d-none">
            <div class="modal-body form-floating mb-3">
              <input
                type="text"
                class="form-control is-invalid text-danger"
                value="ID not made: Server Full"
                readonly
              />
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Close
              </button>
              <button class="btn btn-danger" disabled>Server Full</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--JavaScript at end of body for optimized loading-->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js"
      integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa"
      crossorigin="anonymous"
    ></script>
    <script>
      function webSocket(str) {
        return new WebSocket(location.origin.replace(/^http/, "ws") + str);
      }
      async function registerHost() {
        let socket = webSocket("/register-host");
        document
          .getElementById("host-modal")
          .addEventListener("hidden.bs.modal", (event) => {
            if (socket) socket.close();
          });
        socket.onmessage = (event) => {
          let msg = JSON.parse(event.data);
          console.log(msg);

          switch (msg["status"]) {
            case "ServerFull":
              document.getElementById("server-full").className =
                "container-fluid";
              document.getElementById("host-form").style.display = "none";
              break;
            case "Registered":
              document.getElementById("game-id").value = msg["game-id"];
              document.getElementById("server-full").className = "d-none";
              document.getElementById("host-form").style.display = "block";
              break;
            case "ServerClosed":
              document.getElementById("game-id").value = "id-not-made";
              document.getElementById("server-full").className = "d-none";
              document.getElementById("host-form").style.display = "block";
              alert("Server has been closed");
              break;
            case "Invalid":
              document.getElementById("game-id").value =
                "Client-Side Error: " + msg["error"];
              document.getElementById("server-full").className = "d-none";
              document.getElementById("host-form").style.display = "block";
              break;
            case "RoomFound":
              break;
            case "RoomNotFound":
              break;
            default:
          }
        };
      }
      async function registerJoin() {
        let socket = webSocket("/register-join");
        socket.onopen = (event) => {
          socket.onmessage = (event) => {
            let msg = JSON.parse(event.data);
            console.log(msg);
          switch (msg["status"]) {
            case "RoomFound":
              break;
            case "RoomNotFound":
              break;
            default:
          }
          };
          document
            .getElementById("join-modal")
            .addEventListener("hidden.bs.modal", (event) => {
              if (socket) socket.close();
            });
          document
            .getElementById("join-button")
            .addEventListener("click", (event) => {
              let text = document.getElementById("game-id-query").value;
              console.log("TEXT: " + text);
              socket.send(text);
            });
        };
      }
      async function awaitOpen(socket) {
        socket.on;
      }
    </script>
  </body>
</html>
